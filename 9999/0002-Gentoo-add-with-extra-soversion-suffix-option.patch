From c36545a2592823130ca8054abcc8d308426f8056 Mon Sep 17 00:00:00 2001
Message-ID: <c36545a2592823130ca8054abcc8d308426f8056.1762160821.git.sam@gentoo.org>
In-Reply-To: <2417d4ce6d1ab1c54d0b384f8d2d98a4b8545b09.1762160821.git.sam@gentoo.org>
References: <2417d4ce6d1ab1c54d0b384f8d2d98a4b8545b09.1762160821.git.sam@gentoo.org>
From: Sergei Trofimovich <slyfox@gentoo.org>
Date: Tue, 20 Jul 2021 21:12:38 +0200
Subject: [PATCH 2/4] Gentoo: add --with-extra-soversion-suffix= option
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

--with-extra-soversion-suffix= will allow Gentoo to
distinct libbfd.so and libopcodes.so to have more precise
SONAME.

Today --enable-targets=all and --enable-64-bit-bfd change
libbfd.so ABI:
--enable-targets=all adds new symbols to the library
--enable-64-bit-bfd modifies BFD_ARCH_SIZE default and
changes sizes of integer parameters and fields to most
APIs.

--with-extra-soversion-suffix= will allow Gentoo to inject
additional keys into SONAME to indicate ABI change and avoid
hard to diagnose crashes when user reinstalls libbfd.so
built with different flags (see https://bugs.gentoo.org/663690).

Bug: https://bugs.gentoo.org/666100
Signed-off-by: Sergei Trofimovich <slyfox@gentoo.org>

Ported to binutils 2.37 by Andreas K. HÃ¼ttel <dilfridge@gentoo.org>
---
 bfd/Makefile.am  |  5 +++++
 bfd/Makefile.in  |  4 ++++
 bfd/compress.c   |  2 +-
 bfd/configure    | 17 +++++++++++++++--
 bfd/configure.ac |  7 +++++++
 5 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/bfd/Makefile.am b/bfd/Makefile.am
index 3c3243269f1..719d5f2bb52 100644
--- a/bfd/Makefile.am
+++ b/bfd/Makefile.am
@@ -64,6 +64,8 @@ bfdinclude_HEADERS += $(INCDIR)/plugin-api.h
 LIBDL = @lt_cv_dlopen_libs@
 endif
 
+EXTRA_SOVERSION_SUFFIX = @EXTRA_SOVERSION_SUFFIX@
+
 # bfd.h goes here, for now
 BFD_H = bfd.h
 
@@ -993,6 +995,9 @@ bfdver.h: $(srcdir)/version.h $(srcdir)/development.sh $(srcdir)/Makefile.in
 	  bfd_version_string="\"$(VERSION).$${bfd_version_date}\"" ;\
 	  bfd_soversion="$(VERSION).$${bfd_version_date}" ;\
 	fi ;\
+	if test x"$(EXTRA_SOVERSION_SUFFIX)" != x ; then \
+	  bfd_soversion="$${bfd_soversion}.$(EXTRA_SOVERSION_SUFFIX)" ;\
+	fi ;\
 	$(SED) -e "s,@bfd_version@,$$bfd_version," \
 	    -e "s,@bfd_version_string@,$$bfd_version_string," \
 	    -e "s,@bfd_version_package@,$$bfd_version_package," \
diff --git a/bfd/Makefile.in b/bfd/Makefile.in
index 6d1944c2664..07b1084f6b7 100644
--- a/bfd/Makefile.in
+++ b/bfd/Makefile.in
@@ -349,6 +349,7 @@ ECHO_T = @ECHO_T@
 EGREP = @EGREP@
 EXEEXT = @EXEEXT@
 EXEEXT_FOR_BUILD = @EXEEXT_FOR_BUILD@
+EXTRA_SOVERSION_SUFFIX = @EXTRA_SOVERSION_SUFFIX@
 FGREP = @FGREP@
 GENCAT = @GENCAT@
 GMSGFMT = @GMSGFMT@
@@ -2464,6 +2465,9 @@ bfdver.h: $(srcdir)/version.h $(srcdir)/development.sh $(srcdir)/Makefile.in
 	  bfd_version_string="\"$(VERSION).$${bfd_version_date}\"" ;\
 	  bfd_soversion="$(VERSION).$${bfd_version_date}" ;\
 	fi ;\
+	if test x"$(EXTRA_SOVERSION_SUFFIX)" != x ; then \
+	  bfd_soversion="$${bfd_soversion}.$(EXTRA_SOVERSION_SUFFIX)" ;\
+	fi ;\
 	$(SED) -e "s,@bfd_version@,$$bfd_version," \
 	    -e "s,@bfd_version_string@,$$bfd_version_string," \
 	    -e "s,@bfd_version_package@,$$bfd_version_package," \
diff --git a/bfd/compress.c b/bfd/compress.c
index 28788370210..3badf1e5896 100644
--- a/bfd/compress.c
+++ b/bfd/compress.c
@@ -641,7 +641,7 @@ bfd_compress_section_contents (bfd *abfd, sec_ptr sec)
 					   compressed_size,
 					   input_buffer,
 					   uncompressed_size,
-					   ZSTD_CLEVEL_DEFAULT);
+					   19);
 	  if (ZSTD_isError (compressed_size))
 	    {
 	      bfd_release (abfd, buffer);
diff --git a/bfd/configure b/bfd/configure
index d9d77b7004c..f238da28e61 100755
--- a/bfd/configure
+++ b/bfd/configure
@@ -701,6 +701,7 @@ WARN_CFLAGS
 REPORT_BUGS_TEXI
 REPORT_BUGS_TO
 PKGVERSION
+EXTRA_SOVERSION_SUFFIX
 DEBUGDIR
 PLUGINS_FALSE
 PLUGINS_TRUE
@@ -841,6 +842,7 @@ enable_secureplt
 enable_separate_code
 enable_leading_mingw64_underscores
 with_separate_debug_dir
+with_extra_soversion_suffix
 with_pkgversion
 with_bugurl
 enable_werror
@@ -1529,6 +1531,8 @@ Optional Packages:
   --with-separate-debug-dir=DIR
                           Look for global separate debug info in DIR
                           [[default=LIBDIR/debug]]
+  --with-extra-soversion-suffix=SUFFIX
+                          Append '.SUFFIX' to SONAME [[default=]]
   --with-pkgversion=PKG   Use PKG in the version string in place of "GNU
                           Binutils"
   --with-bugurl=URL       Direct users to URL to report a bug
@@ -11527,7 +11531,7 @@ else
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 11530 "configure"
+#line 11534 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -11633,7 +11637,7 @@ else
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 11636 "configure"
+#line 11640 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -12393,6 +12397,15 @@ fi
 
 
 
+EXTRA_SOVERSION_SUFFIX=
+
+# Check whether --with-extra-soversion-suffix was given.
+if test "${with_extra_soversion_suffix+set}" = set; then :
+  withval=$with_extra_soversion_suffix; EXTRA_SOVERSION_SUFFIX="${withval}"
+fi
+
+
+
 
 
 # Check whether --with-pkgversion was given.
diff --git a/bfd/configure.ac b/bfd/configure.ac
index 4fb3bf41f34..b52eba399f1 100644
--- a/bfd/configure.ac
+++ b/bfd/configure.ac
@@ -163,6 +163,13 @@ AC_ARG_WITH(separate-debug-dir,
 [DEBUGDIR="${withval}"])
 AC_SUBST(DEBUGDIR)
 
+EXTRA_SOVERSION_SUFFIX=
+AC_ARG_WITH(extra-soversion-suffix,
+  AS_HELP_STRING([--with-extra-soversion-suffix=SUFFIX],
+                 [Append '.SUFFIX' to SONAME [[default=]]]),
+[EXTRA_SOVERSION_SUFFIX="${withval}"])
+AC_SUBST(EXTRA_SOVERSION_SUFFIX)
+
 ACX_PKGVERSION([GNU Binutils])
 ACX_BUGURL([https://sourceware.org/bugzilla/])
 
-- 
2.51.2

